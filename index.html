<html>
<head>
  <title></title>
  <style type="text/css">
  .olControlLoadingPanel {
    background-image:url(http://dev.openlayers.org/addins/loadingPanel/trunk/theme/default/img/loading.gif);
    margin-left: 45%;
    margin-top: 10%;
    position: absolute;
    width: 205px;
    height: 11px;
    background-position:center;
    background-repeat:no-repeat;
    display: none;
    z-index:15000;
  }

  div.olControlAttribution {
      left:10px;
      bottom:10px;
  }
  </style>
  <link rel="stylesheet" type="text/css" href="stylesheets/layer-buttons.css"/>
  <script src="http://openlayers.org/api/2.12/OpenLayers.js" type="text/javascript"></script>
  <script type="text/javascript" src="javascripts/OSMBuildings-OpenLayers.js"></script>
  <script type="text/javascript" src="javascripts/LoadingPanel.js"></script>
  <script type="text/javascript">
    function toTitleCase(str){
        if(str){
          // debugger;
          string = str.replace(/_/," ");
          string = string.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        }
        else{
          string = "";
        }
        return string;
    }
  </script>
  <script type="text/javascript">
  var lat = 27.72293;
  // var lat=52.49480;
  var lon = 85.33138;
  // var lon=13.42857;
  var zoom=18;
  var map;
  var layer;
  var geojson_format = new OpenLayers.Format.GeoJSON();
  var loadingpanel = new OpenLayers.Control.LoadingPanel();
  var zoom_data_limit= 13,
  proj900913 = new OpenLayers.Projection("EPSG:900913");
  proj4326 = new OpenLayers.Projection("EPSG:4326");

  building_color = {"load_bearing_structure":'#F2721D',"framed_structure":'#9DA0A3',"adobe":'#deb887',"other":'#1D68F2'}


  function setStatusText(text){
    var html_node = document.getElementById("statusline");
    if (html_node != null){
      var div = html_node.firstChild;
      div.deleteData(0, div.nodeValue.length);
      div.appendData(text);
    }
  }

  ZoomLimitedBBOXStrategy = OpenLayers.Class(OpenLayers.Strategy.BBOX, {

    zoom_data_limit: 13,

    initialize: function(zoom_data_limit) {
      this.zoom_data_limit = zoom_data_limit;
    },

    update: function(options) {
      this.ratio = this.layer.ratio;
      var mapBounds = this.getMapBounds();
      if (this.layer && this.layer.map && this.layer.map.getZoom() < this.zoom_data_limit) {
        setStatusText("Please zoom in to view data.");
        zoom_valid = false;

        this.bounds = null;
      }
      else if (mapBounds !== null && ((options && options.force) ||
       this.invalidBounds(mapBounds))) {
          // ++load_counter;
        setStatusText("Loading data ...");
        zoom_valid = true;

        this.calculateBounds(mapBounds);
        this.resolution = this.layer.map.getResolution();
        this.triggerRead(options);
        setStatusText("Loading Complete");
      }
    },

    CLASS_NAME: "ZoomLimitedBBOXStrategy"
  });

function init(){
  map = new OpenLayers.Map ("map", {
    controls:[
    new OpenLayers.Control.Navigation(),
    new OpenLayers.Control.PanZoomBar(),
    new OpenLayers.Control.Attribution(),
    // new OpenLayers.Control.MousePosition()
    ],
    maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
    maxResolution: 156543.0399,
    numZoomLevels: 19,
    units: 'm',
    projection: new OpenLayers.Projection("EPSG:4326"),
    displayProjection: new OpenLayers.Projection("EPSG:4326"),
    restrictedExtent: new OpenLayers.Bounds(85.321970,27.717840,85.347290,27.740936).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"))
  });
  // map.addLayer(new OpenLayers.Layer.OSM("OSM",null,{attribution: "&copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors (ODbL)"}));

  var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));

  var mapbox = new OpenLayers.Layer.XYZ(
    "Natural Earth",
    [
    "http://a.tiles.mapbox.com/v3/amritkarma.map-6c5zckhu/${z}/${x}/${y}.png",
    "http://b.tiles.mapbox.com/v3/amritkarma.map-6c5zckhu/${z}/${x}/${y}.png",
    "http://c.tiles.mapbox.com/v3/amritkarma.map-6c5zckhu/${z}/${x}/${y}.png",
    "http://d.tiles.mapbox.com/v3/amritkarma.map-6c5zckhu/${z}/${x}/${y}.png"
    ], {
      attribution: "Tiles &copy; <a href='http://mapbox.com/'>MapBox</a>",
      sphericalMercator: true,
      wrapDateLine: false,
          // numZoomLevels: 5,
          isBaseLayer:true
        }
        );
  map.addLayer(mapbox);

  map.setCenter(lonLat, zoom);
  map.addControl(loadingpanel);
// http://a.tiles.mapbox.com/v3/amritkarma.map-6c5zckhu/page.html
                //webdri building data
                building_url = "http://overpass-api.de/api/interpreter?data=(way['building'](bbox);node(w););out body qt;"; //main working url
                //var data_url = "Ktm valley 2013-01-01_10-47.osm";

                building = new OpenLayers.Layer.Vector("Building", {
                  strategies: [new ZoomLimitedBBOXStrategy(17,{ratio:2})],
                    // strategies:[new OpenLayers.Strategy.BBOX()],
                    protocol: new OpenLayers.Protocol.HTTP({
                      url: building_url,
                        //<-- relative or absolute URL to your .osm file
                        format: new OpenLayers.Format.OSM()
                      }),
                    projection: new OpenLayers.Projection("EPSG:4326"),
                    styleMap: new OpenLayers.StyleMap({
                      'default': new OpenLayers.Style({
                        'strokeWidth': 0.1,
                        fillColor: "transparent",
                        'title': '${name}'
                      })
                    })
                  });
                map.addLayer(building);

                layer2 = new OSMBuildings(map);//v0.1.9
                // layer2 = new OpenLayers.Layer.Buildings();//v0.1.8
                // map.addLayer(layer2);
                
                building.events.on({
                  "featuresadded": function(feature) {
                        // debugger;
                        // loadingpanel.activate();
                        console.log('feature added');
                        for (i = 0; i < feature.features.length; i++) {
                          if (typeof(feature.features[i].attributes["building:level"])!="number"){
                            feature.features[i].attributes["height"] = 20;
                          } else {
                            feature.features[i].attributes["height"] = feature.features[i].attributes["building:level"] * 10;
                          }

                          feature.features[i].geometry.transform(proj900913,proj4326);

                            // debugger;

                            attributes = feature.features[i].attributes

                            // Give color on basis of sructural system

                            if(attributes["building:structure"]){
                              if(attributes["building:structure"].match("reinforced_concrete")){
                                // alert();
                                // console.log(attributes["building:structure"]);
                                attributes["wallColor"] = building_color["framed_structure"];
                                attributes["roofColor"] = attributes["wallColor"];
                                
                              }
                              else if(attributes["building:structure"].match("load_bearing")){
                                // console.log(attributes["building:structure"]);
                                attributes["wallColor"] = building_color["load_bearing_structure"];
                                attributes["roofColor"] = attributes["wallColor"];
                                
                              }
                              else if(attributes["building:structure"].match("adobe")){
                                // console.log(attributes["building:structure"]);
                                attributes["wallColor"] = building_color["adobe"];
                                attributes["roofColor"] = attributes["wallColor"];
                                
                              }
                              else{
                                attributes["wallColor"] = building_color["other"];
                                attributes["roofColor"] = attributes["wallColor"];
                                 
                              }
                              // for educational and health buildings use different color
                              // debugger;
                              // if(attributes["building"]=='school' || attributes["building"]=='college'){
                              //   attributes["wallColor"] = building_color["educational"];
                              //   attributes["roofColor"] = attributes["wallColor"];
                              // }
                              // else if(attributes["building"]=='hospital' || attributes["building"]=='clinic' || attributes["building"]=='dentist'){
                              //   attributes["wallColor"] = building_color["health"];
                              //   attributes["roofColor"] = attributes["wallColor"];
                              // }
                            }
                            else{
                              attributes["wallColor"] = building_color["other"];
                              attributes["roofColor"] = attributes["wallColor"];
                               
                            }
                          }
                          geojson_string = geojson_format.write(building.features);
                          // console.log(geojson_string);
                          layer2.setData(JSON.parse(geojson_string));
                          layer2.setStyle({shadows:false});
                        // layer2.osmb.geoJSON(JSON.parse(geojson_string));
                        // layer2.osmb.setStyle({ color: '#ffff72',roofColor:'#ffff72'});
                      }
                    });
              }
              </script>
            </head>
            <body onload="init()">
              <div id="map" class="smallmap">
                <div style="background:#D5DCDE">
                  <h3 style="">Building 3D Visualization (Wards 4 & 5; Kathmandu Meropolitan City)</h3>
                  <div id="statusline" style="font-size:12pt; font-weight:bold; font-family:sans-serif">No status set yet.
                  </div>
                </div>
              </div>
              <div style="position:absolute; bottom:20px; right:20px; font:aerial; fontcolor:blue; z-index:999; background:aliceblue" id="legend">LEGEND
              </div>
              <script type="text/javascript">
                legendpanel = document.getElementById("legend");
                legendtable = document.createElement("table")
                for(var color in building_color){
                  row = document.createElement('tr');
                  col1  = document.createElement('td');
                  col1.style.backgroundColor = building_color[color];
                  col1.style.width = "20px";
                  col1.style.height = "10px";
                 
                  col2  = document.createElement('td');
                  col2.innerHTML = toTitleCase(color.replace(/_/g," "))+"<br>";
                  col2.style.fontSize = 'medium';

                  row.appendChild(col1);
                  row.appendChild(col2);
                  legendtable.appendChild(row);
                }
                legendpanel.appendChild(legendtable);
              </script>
          </body>
          </html>
